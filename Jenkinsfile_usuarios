// Scripted Pipeline para ejecutar tareas en paralelo para cada usuario

node {


    stage('Checkout') {
        echo "Clonando repositorio..."
        deleteDir()
        checkout scmGit(branches: [[name: '*/dev']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/manuel-agilgob/self-hosted-runner.git']])
    }

    stage('Instalar dependencias') {
        echo "Instalando dependencias..."
        sh "npm install"  
    }



    def rutaPruebas = "cypress/e2e"
    def carpetasUsuarios = sh(script: "ls ${rutaPruebas}", returnStdout: true).trim().split('\n')
    def colaUsuarios = carpetasUsuarios as List
    echo "Carpetas por usuario: ${carpetasUsuarios}"


    def carpetaUsuarioRunner1 = ''
    def carpetaUsuarioRunner2 = ''

    stage('Generacion dinamica de stages de pruebas') {
        def parallelStages = [:]


        // Definir las etapas paralelas
        parallelStages['Runner 1'] = {
            while (!colaUsuarios.isEmpty()){
                carpetaUsuarioRunner1 = colaUsuarios.remove(0)  // Remover el primer usuario
                stage("Stage for ${rutaPruebas}/${carpetaUsuarioRunner1}") {
                    echo "Ejecutando pruebas para ${rutaPruebas}/${carpetaUsuarioRunner1}"
                    sh(script: "npx cypress run --spec ${rutaPruebas}/${carpetaUsuarioRunner1}/*cy.js --reporter cypress-mochawesome-reporter --quiet")
                }
            }
        }


        parallelStages['Runner 2'] = {
            while (!colaUsuarios.isEmpty()){
                carpetaUsuarioRunner2 = colaUsuarios.remove(0)  // Remover el primer usuario
                stage("Stage for ${rutaPruebas}/${carpetaUsuarioRunner2}") {
                    
                    def token_r1 = sh(
                            script: '''
                                curl -X POST http://192.168.1.73:3000/token \
                                -H "Content-Type: application/json" \
                                -d '{"username": "value1", "password": "value2"}' \
                                -s --fail
                            ''',
                            returnStdout: true
                        ).trim()

                    echo "Ejecutando pruebas para ${rutaPruebas}/${carpetaUsuarioRunner2} con token ${token_r1}"

                    sh(script: """
                        npx cypress run \
                        --spec ${rutaPruebas}/${carpetaUsuarioRunner2}/*cy.js \
                        --reporter cypress-mochawesome-reporter \
                        --quiet  \
                        --env TOKEN=${token_r1}""")
                }
            }
        }


        // Ejecutar las etapas en paralelo
        parallel parallelStages
    }

    stage('Generar reporte html'){
        echo "Generando reporte html..."
        sh "npx marge --reportDir=cypress/reports/mochawesome-report --reportTitle='Reporte de pruebas Cypress'"
    }

    stage {
        echo "Publicando reportes..."
        archiveArtifacts artifacts: 'reports/**/*', allowEmptyArchive: true        
    }
}
